{% extends 'web/base.html' %}
{% block content %}

{{ bokeh_js|safe }}

<style>
    .dashboard-container { max-width: 1000px; margin: 0 auto; padding: 40px 20px; font-family: sans-serif; }
    .dashboard-header { text-align: center; margin-bottom: 20px; color: #333; }
    .version-tag { text-align: center; color: #dc3545; font-weight: bold; margin-bottom: 30px; }
    .filter-card {
        background: #fff; padding: 30px; border-radius: 16px; margin-bottom: 50px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.06);
    }
    .main-select, .secondary-select { 
        padding: 10px; border-radius: 8px; border: 1px solid #ccc; width: 100%; max-width: 300px; display: block; margin: 0 auto 15px; 
    }
    .filter-section { display: none; }
    .filter-section.active { display: block; }
    .btn-apply {
        display: block; margin: 0 auto; background: #dc3545;
        color: #fff; border: none; padding: 12px 50px;
        border-radius: 30px; font-weight: bold; cursor: pointer; transition: 0.2s;
    }
    .btn-apply:hover { background: #c82333; }
    .range-slider-wrapper { position: relative; width: 100%; max-width: 600px; margin: 20px auto; height: 40px; }
    .slider-track-bg { position: absolute; width: 100%; height: 6px; background: #ddd; top: 50%; transform: translateY(-50%); }
    .slider-track-fill { position: absolute; height: 6px; background: #dc3545; top: 50%; transform: translateY(-50%); z-index: 1; }
    .range-input { position: absolute; width: 100%; background: none; pointer-events: none; -webkit-appearance: none; top: 50%; margin: 0; z-index: 2; }
    .range-input::-webkit-slider-thumb { pointer-events: auto; -webkit-appearance: none; width: 24px; height: 24px; background: #dc3545; border: 3px solid #fff; border-radius: 50%; cursor: pointer; margin-top: -9px; }
    .chart-list { display: flex; flex-direction: column; gap: 50px; }
    .chart-card {
        background: #fff; border-radius: 12px; padding: 20px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.06);
        display: flex; justify-content: center; overflow: hidden;
    }
    .debug-box { background: #f8f9fa; border: 1px solid #ddd; padding: 10px; margin: 20px 0; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; }
    .stats-row { 
        display: flex; justify-content: space-around; background: #f8f9fa; 
        padding: 15px; border-radius: 8px; margin-bottom: 20px; 
    }
    .stat-item { text-align: center; }
    .stat-value { font-size: 1.2em; color: #dc3545; font-weight: bold; }
</style>

<div class="dashboard-container">
    <h1 class="dashboard-header">Аналітика</h1>
    <div class="version-tag">Версія 2: Bokeh Framework</div>

    <div class="filter-card">
        <form method="get" id="filterForm" onsubmit="return clearInactiveFields()">
            <div style="text-align: center; margin-bottom: 20px;">
                <label>Фільтрувати за:</label>
                <select name="filter_type" id="filterTypeSelect" class="main-select" onchange="toggleFilters()">
                    <option value="year" {% if filter_type == 'year' %}selected{% endif %}>Роками</option>
                    <option value="genre" {% if filter_type == 'genre' %}selected{% endif %}>Жанром</option>
                    <option value="country" {% if filter_type == 'country' %}selected{% endif %}>Країною</option>
                </select>
            </div>

            <div id="yearSection" class="filter-section {% if filter_type == 'year' %}active{% endif %}">
                <div style="text-align: center; margin-bottom: 10px; font-weight: bold;">
                    <span id="minDisplay">{{ min_year }}</span> — <span id="maxDisplay">{{ max_year }}</span>
                </div>
                <div class="range-slider-wrapper">
                    <div class="slider-track-bg"></div>
                    <div class="slider-track-fill" id="sliderTrack"></div>
                    <input type="range" name="min_year" min="1950" max="2025" value="{{ min_year }}" class="range-input" id="inputMin">
                    <input type="range" name="max_year" min="1950" max="2025" value="{{ max_year }}" class="range-input" id="inputMax">
                </div>
            </div>

            <div id="genreSection" class="filter-section {% if filter_type == 'genre' %}active{% endif %}">
                <select name="genre" class="secondary-select">
                    <option value="" disabled selected>-- Оберіть жанр --</option>
                    {% for g in all_genres %}<option value="{{ g }}" {% if selected_genre == g %}selected{% endif %}>{{ g }}</option>{% endfor %}
                </select>
            </div>

            <div id="countrySection" class="filter-section {% if filter_type == 'country' %}active{% endif %}">
                 <select name="country" class="secondary-select">
                    <option value="" disabled selected>-- Оберіть країну --</option>
                    {% for c in all_countries %}<option value="{{ c }}" {% if selected_country == c %}selected{% endif %}>{{ c }}</option>{% endfor %}
                </select>
            </div>
            
            <button type="submit" class="btn-apply">Застосувати</button>
        </form>
    </div>

    <div class="chart-list">
        {% if debug_log %}
        <div class="debug-box">
            <b>Debug Log:</b><br>
            {% for line in debug_log %}{{ line }}<br>{% endfor %}
        </div>
        {% endif %}

        <div class="chart-card">{% if divs.chart1 %}{{ divs.chart1|safe }}{% else %}Дані відсутні{% endif %}</div>
        <div class="chart-card">{% if divs.chart2 %}{{ divs.chart2|safe }}{% else %}Дані відсутні{% endif %}</div>
        <div class="chart-card">{% if divs.chart3 %}{{ divs.chart3|safe }}{% else %}Дані відсутні{% endif %}</div>
        <div class="chart-card">{% if divs.chart4 %}{{ divs.chart4|safe }}{% else %}Дані відсутні{% endif %}</div>
        <div class="chart-card">{% if divs.chart5 %}{{ divs.chart5|safe }}{% else %}Дані відсутні{% endif %}</div>
        <div class="chart-card">{% if divs.chart6 %}{{ divs.chart6|safe }}{% else %}Дані відсутні{% endif %}</div>
    </div>
</div>

{{ script|safe }}

<script>
    function clearInactiveFields() {
        const type = document.getElementById('filterTypeSelect').value;
        if (type !== 'year') {
            document.getElementById('inputMin').removeAttribute('name');
            document.getElementById('inputMax').removeAttribute('name');
        } else {
            document.getElementById('inputMin').setAttribute('name', 'min_year');
            document.getElementById('inputMax').setAttribute('name', 'max_year');
        }
        const genreSelect = document.querySelector('#genreSection select');
        if (type !== 'genre') {
            genreSelect.removeAttribute('name');
        } else {
            genreSelect.setAttribute('name', 'genre');
        }
        const countrySelect = document.querySelector('#countrySection select');
        if (type !== 'country') {
            countrySelect.removeAttribute('name');
        } else {
            countrySelect.setAttribute('name', 'country');
        }
        return true;
    }

    function toggleFilters() {
        const type = document.getElementById('filterTypeSelect').value;
        document.getElementById('yearSection').classList.remove('active');
        document.getElementById('genreSection').classList.remove('active');
        document.getElementById('countrySection').classList.remove('active');
        if (type === 'year') document.getElementById('yearSection').classList.add('active');
        else if (type === 'genre') document.getElementById('genreSection').classList.add('active');
        else if (type === 'country') document.getElementById('countrySection').classList.add('active');
    }
    
    document.addEventListener("DOMContentLoaded", function() {
        const iMin = document.getElementById("inputMin");
        const iMax = document.getElementById("inputMax");
        const dMin = document.getElementById("minDisplay");
        const dMax = document.getElementById("maxDisplay");
        const track = document.getElementById("sliderTrack");
        const minVal = parseInt(iMin.min);
        const maxVal = parseInt(iMin.max);

        function update() {
            let v1 = parseInt(iMin.value), v2 = parseInt(iMax.value);
            if (v2 < v1) { if (this === iMin) iMin.value = v2; else iMax.value = v1; }
            v1 = parseInt(iMin.value); v2 = parseInt(iMax.value);
            dMin.innerText = v1; dMax.innerText = v2;
            const p1 = ((v1-minVal)/(maxVal-minVal))*100;
            const p2 = ((v2-minVal)/(maxVal-minVal))*100;
            track.style.left = p1+"%"; track.style.width = (p2-p1)+"%";
        }
        iMin.oninput = update; iMax.oninput = update;
        update();
        toggleFilters();
        clearInactiveFields();
    });
</script>
{% endblock %}
